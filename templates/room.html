{% extends 'base.html' %}

{% block content %}
<section id="screen">
<div id="player"></div>
<div id="sidebar">
  <div class="tabs">
    <div class="tab active" id="chat">
      <i class="material-icons">chat_bubble_outline</i>
    </div>
    <div class="tab" id="play">
      <i class="material-icons">playlist_play</i>
    </div>
    <div class="tab" id="settings">
      <i class="material-icons">settings</i>
    </div>
  </div>
  <div id="chat-content">
    <div class="message">
      <span class="name">Ronin:</span> wow
    </div>
    <div class="message">
      <span class="name">Ronin:</span> wow
    </div>
    <div class="message">
      <span class="name">Ronin:</span> wow
    </div>
    <input id="text-input" />
  </div>
</div>
</section>
<script type="text/javascript" src="//cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
  $('.tab').click(function (event) {
    $('.tab').removeClass('active')
    $(event.currentTarget).addClass('active')
  })
</script>
<script>
  var socket = io('http://' + document.domain + ':' + location.port);

  var ignore = true

  function supress() {
    ignore = true
    setTimeout(() => {
      ignore = false
    }, 300)
  }

  var room = '{{ room_id }}'
  socket.on('connect', function() {
    socket.emit('join', room);
  });

  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      videoId: '{{ room.video_id }}',
      playerVars: { 'autoplay': 1, 'color': 'white' },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
    supress()
  }

  socket.on('play', (time) => {
    if (Math.abs(player.getCurrentTime() - time) > 3 || player.getPlayerState() != 1) {
      player.seekTo(time)
      player.playVideo()
      supress()
    }
  })

  socket.on('chat', (message) => {
    $( "#chat-content" ).append('<div class="message">' + message + '</div>');
  })

  $('#chat-content input').keypress(function (e) {
    if (e.which == 13) {
      var input = $('#chat-content input')
      socket.emit('chat', room, "R", input.val())
      input.val('')
      return false;
    }
  });

  socket.on('pause', (time) => {
    if (Math.abs(player.getCurrentTime() - time) > 3 || player.getPlayerState() != 2) {
      player.seekTo(time)
      player.pauseVideo()
      supress()
    }
  })

  function onPlayerReady(event) {
    event.target.seekTo({{ time }})
    event.target.playVideo()
  }

  function onPlayerStateChange(event) {
    if (!ignore) {
      if (event.data == 2) {
        socket.emit('pauseAt', room, player.getCurrentTime())
      } else if (event.data == 1) {
        socket.emit('playAt', room, player.getCurrentTime())
      }
    }
  }
</script>
{% endblock %}
